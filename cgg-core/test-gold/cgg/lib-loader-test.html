<!DOCTYPE html>
<html>
<head>
    <title>CCC Loader tester</title>
    <script type="text/javascript">
    var _TestHook_ = {};
    var print = function(s) { console.log(s); };
    var lib   = function(s) { console.log("lib('" + s + "')"); };
    /*
    var params = {
        cccVersion: '0',
        get: function(p) { return this[p]; }
    };
    */
    </script>
    <script type="text/javascript" src="../../src/pt/webdetails/cgg/resources/lib/CCC/loader.js"></script>
    <script type="text/javascript">
    (function() {
        var LibLoader = _TestHook_.cccLibLoader;
        var Version   = LibLoader.Version;

        Version.prototype.equals = function(other) {
            return !!other &&
                   this.major   === other.major &&
                   this.minor   === other.minor &&
                   this.variant === other.variant;
        };
        
        var emptyPaths = function() { return []; };

        var rootLib1 = function() {
            return {
                children: [
                    {
                        component: 4,
                        children: [
                            {component: 5, version: new Version(4, 5), paths: emptyPaths},
                            {component: 1, version: new Version(4, 1), paths: emptyPaths}
                        ]
                    },
                    {
                        component: 2, 
                        children: [
                            {component: 3, version: new Version(2, 3, 'bar'),      paths: emptyPaths},
                            {component: 3, version: new Version(2, 3),             paths: emptyPaths},
                            {component: 0, version: new Version(2, 0, 'analyzer'), paths: emptyPaths},
                            {component: 0, version: new Version(2),                paths: emptyPaths},
                        ]
                    },
                    {
                        component: 1, 
                        children: [
                            {component: 0, version: new Version(1, 0, 'foo'),      paths: emptyPaths},
                        ]
                    },
                    {
                        component: 0, 
                        children: [
                            {component: 1, version: new Version(0, 1),             paths: emptyPaths},
                            {component: 0, version: new Version(0, 0, 'foo'),      paths: emptyPaths}
                        ]
                    }
                ]
            };
        };
              
        // Arguments for doTest
        var testCases = [
            [rootLib1, '0', '0.1'], // Oldest
            [rootLib1, '0-foo', '0-foo'],
            [rootLib1, '1', '2'],
            [rootLib1, '1.9-analyzer', '2.0'],
            [rootLib1, '1.9', '2.0'],
            [rootLib1, '2.0', '2.0'],
            [rootLib1, '2.0-test', '2.0'],
            [rootLib1, '2.0-analyzer', '2.0-analyzer'],
            [rootLib1, '2.2', '2.3'],
            [rootLib1, '2.4', '2.3'],
            [rootLib1, '2.Infinity', '2.3'],
            [rootLib1, '2.Infinity-bar', '2.3'], // Is this ok?
            [rootLib1, '3.1', '4.1'],
            [rootLib1, '3.1-foo', '4.1'],
            [rootLib1, '4',   '4.1'],
            [rootLib1, '4.1', '4.1'],
            [rootLib1, '5',   '4.5'],
            [rootLib1, '5-foo', '4.5'],
            [rootLib1, 'Infinity', '4.5'] // Newest
        ];

        var doTest = function(rootLib, wantVersion, expectedVersion) {
            
            LibLoader.rootLib(rootLib);

            var info = LibLoader.load(wantVersion);
            
            var resultVersion, resultEx;
            try { 
                resultVersion = info && info.version;
            } catch(ex) {
                resultEx = ex;
            }

            wantVersion     = Version.parse(wantVersion   );
            expectedVersion = Version.parse(expectedVersion);

            var success = !resultEx && expectedVersion.equals(resultVersion);

            document.write(
                '<li>' + 
                    '<b>' + wantVersion + '</b>' +
                    ' : ' +
                    '<span ' + 
                        (success ? 
                            'style="color:green;font-weight:bold;"' : 
                            'style="color:red;font-weight:bold;"') + 
                    '>' +
                    (resultEx || resultVersion) +
                    '</span>' +
                    (success ? 
                     '' :
                    (' (expected ' + expectedVersion + ')')) +
                '</li>');

            return success;
        };

        var doTests = function() {
            document.write("<ol>");
            
            testCases.forEach(function(testCase) {
                doTest.apply(null, testCase);
            });

            document.write("</ol>");
        };

        window.addEventListener("load", doTests, false);
    }());
    </script>
</head>
<body>
</body>
</html>
